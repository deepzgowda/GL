AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  Subnet1Id:
    Type: String
    Description: "ID of the first subnet for the Auto Scaling group"
  Subnet2Id:
    Type: String
    Description: "ID of the second subnet for the Auto Scaling group"
  AmiId:
    Type: String
    Description: "ID of the EC2 AMI for the launch configuration"
  InstanceType:
    Type: String
    Description: "Type of EC2 instance for the launch configuration"
  SecurityGroupId:
    Type: String
    Description: "ID of the security group for the launch configuration"

Resources:
  MyAutoScalingGroup:
    Type: "AWS::AutoScaling::AutoScalingGroup"
    Properties:
      DesiredCapacity: 2
      MinSize: 2
      MaxSize: 5
      LaunchConfigurationName:
        Ref: "MyLaunchConfig"
      VPCZoneIdentifier:
        - !Ref Subnet1Id
        - !Ref Subnet2Id

  MyLaunchConfig:
    Type: "AWS::AutoScaling::LaunchConfiguration"
    Properties:
      ImageId: !Ref AmiId
      InstanceType: !Ref InstanceType
      UserData:
        Fn::Base64: 
          Fn::Sub: |
            #!/bin/bash
            INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
            sed -i "s/INSTANCE_ID/$INSTANCE_ID/" /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
            systemctl start amazon-cloudwatch-agent
            systemctl enable amazon-cloudwatch-agent

      SecurityGroups:
        - !Ref SecurityGroupId

  MyMemoryAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmDescription: "Scale up when memory utilization is high"
      Namespace: "CWAgent"
      MetricName: "mem_used_percent"
      Dimensions:
        - Name: "AutoScalingGroupName"
          Value: !Ref "MyAutoScalingGroup"
      ComparisonOperator: "GreaterThanThreshold"
      EvaluationPeriods: 2
      Period: 300
      Statistic: "Average"
      Threshold: 80  
      AlarmActions:
        - Ref: "MyScaleUpPolicy"

  MyScaleUpPolicy:
    Type: "AWS::AutoScaling::ScalingPolicy"
    Properties:
      AdjustmentType: "ChangeInCapacity"
      AutoScalingGroupName:
        Ref: "MyAutoScalingGroup"
      Cooldown: 300
      ScalingAdjustment: 1
